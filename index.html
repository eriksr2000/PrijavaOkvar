<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Prijava okvar strojev</title>

<script src="bazaStrojev.js"></script>
<script src="bazaStrojnikov.js"></script>

<style>
  body{font-family:Arial,sans-serif;background:#f4f4f4;margin:0;padding:12px}
  h1{text-align:center;color:#b52b27;margin-bottom:20px}
  .section{background:#fff;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
  label{font-weight:bold;margin-top:10px;display:block;color:#333}
  select,textarea,input[type=file]{width:100%;padding:12px;font-size:16px;border-radius:10px;border:1px solid #ccc;margin-top:6px;box-sizing:border-box}
  
  .radio-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .radio-btn{flex:1;min-width:80px;text-align:center;padding:12px 5px;border-radius:12px;border:2px solid #ccc;font-size:14px;cursor:pointer;background:#fff;transition:0.2s}
  .radio-btn input{display:none}
  .radio-btn:has(input:checked) {border-color:#d9534f;background:#ffeeee;color:#d9534f;font-weight:bold;}

  button{width:100%;padding:18px;font-size:18px;font-weight:bold;border:none;border-radius:14px;background:#d9534f;color:#fff;margin-top:10px;cursor:pointer;box-shadow:0 4px 6px rgba(217,83,79,0.3)}
  button:active{background:#b52b27;transform:scale(0.98)}
  button:disabled{background:#ccc;cursor:not-allowed}
  
  .hint{font-size:12px;color:#666;margin-top:5px;display:block}
  .error-msg{color:red;font-weight:bold;margin-top:10px;display:none;text-align:center;border: 1px solid red; padding: 10px; border-radius: 5px; background: #fff0f0;}
  .success-msg{color:green;font-weight:bold;margin-top:10px;display:none;text-align:center;border: 1px solid green; padding: 10px; border-radius: 5px; background: #f0fff0;}
</style>
</head>
<body>

<h1>üöß Prijava okvare stroja</h1>

<form id="reportForm">

  <div class="section">
    <label>Stroj</label>
    <select id="stroj" required>
      <option value="" disabled selected>Izberi stroj...</option>
    </select>

    <label>Strojnik</label>
    <select id="strojnik" required>
      <option value="" disabled selected>Izberi strojnika...</option>
    </select>
  </div>

  <div class="section">
    <label>Vrsta okvare</label>
    <div class="radio-row">
      <label class="radio-btn"><input type="radio" name="Vrsta_okvare" value="Mehanska" required><span>Mehanska</span></label>
      <label class="radio-btn"><input type="radio" name="Vrsta_okvare" value="Hidravliƒçna"><span>Hidravliƒçna</span></label>
      <label class="radio-btn"><input type="radio" name="Vrsta_okvare" value="Elektriƒçna"><span>Elektriƒçna</span></label>
      <label class="radio-btn"><input type="radio" name="Vrsta_okvare" value="Drugo"><span>Drugo</span></label>
    </div>

    <label>Opis okvare</label>
    <textarea id="opis" rows="3" placeholder="Kratko opi≈°i te≈æavo..." required></textarea>

    <label>üì∑ Fotografije</label>
    <input type="file" id="fileInput" accept="image/*" capture="environment" multiple>
    <span class="hint">Izbere≈° lahko veƒç slik. (Max 20MB)</span>
    <div id="sizeError" class="error-msg"></div>
  </div>

  <button type="submit" id="submitBtn">Po≈°lji prijavo</button>
  <div id="successMsg" class="success-msg">‚úÖ Prijava uspe≈°no poslana! Hvala.</div>
  <div id="failMsg" class="error-msg">‚ùå Napaka pri po≈°iljanju. Poskusi ponovno.</div>
  
</form>

<script>
// *** NASTAVITVE ***
const email = "svajgerramicerik@gmail.com"; // <--- TUKAJ VPI≈†I SVOJ EMAIL
// ******************

const strojSel = document.getElementById("stroj");
const strojnikSel = document.getElementById("strojnik");

// 1. Polnjenje seznamov
if (typeof stroji !== 'undefined') {
  stroji.forEach(s => {
    const o = document.createElement("option");
    o.value = `${s.inventar} (${s.vrsta})`; 
    o.textContent = `${s.inventar} ‚Äì ${s.vrsta} ${s.proizvajalec}`;
    strojSel.appendChild(o);
  });
}

if (typeof strojniki !== 'undefined') {
  Object.entries(strojniki).forEach(([id, ime]) => {
    const o = document.createElement("option");
    o.value = `${id} - ${ime}`; 
    o.dataset.id = id;          
    o.textContent = `${id} ‚Äì ${ime}`;
    strojnikSel.appendChild(o);
  });
}

// 2. Logika po≈°iljanja
const form = document.getElementById("reportForm");
const submitBtn = document.getElementById("submitBtn");
const fileInput = document.getElementById("fileInput");
const sizeError = document.getElementById("sizeError");
const successMsg = document.getElementById("successMsg");
const failMsg = document.getElementById("failMsg");
const opisInput = document.getElementById("opis");

form.addEventListener("submit", function(e) {
  e.preventDefault(); // Prepreƒçi navadno po≈°iljanje
  
  // Skrij stara sporoƒçila
  successMsg.style.display = "none";
  failMsg.style.display = "none";
  sizeError.style.display = "none";

  // Preveri velikost slik
  const files = fileInput.files;
  let totalSize = 0;
  for (let i = 0; i < files.length; i++) totalSize += files[i].size;

  if (totalSize > 23 * 1048576) {
    sizeError.style.display = "block";
    sizeError.textContent = `‚ö†Ô∏è Slike so prevelike (${(totalSize/1048576).toFixed(1)} MB). Limit je 23 MB.`;
    return;
  }

  // Pripravi podatke za po≈°iljanje (FormData)
  const formData = new FormData();
  
  // Zadeva (Subject)
  const strojVal = strojSel.value.split(' ')[0] || "Neznano";
  const strojnikOption = strojnikSel.options[strojnikSel.selectedIndex];
  const strojnikVal = strojnikOption.dataset.id || "Neznano";
  const vrstaEl = document.querySelector('input[name="Vrsta_okvare"]:checked');
  const vrstaVal = vrstaEl ? vrstaEl.value : "Drugo";
  
  // Dodaj konfiguracijo za FormSubmit
  formData.append("_captcha", "false");
  formData.append("_template", "table");
  formData.append("_subject", `Stroj - "${strojVal}"; Strojnik - "${strojnikVal}"; Vrsta okvare - "${vrstaVal}"`);
  
  // Dodaj besedilna polja
  formData.append("Stroj", strojSel.value);
  formData.append("Strojnik", strojnikSel.value);
  formData.append("Vrsta_okvare", vrstaVal);
  formData.append("Opis_okvare", opisInput.value);

  // *** KLJUƒåNI DEL: Dodajanje slik ***
  // Roƒçno dodamo vsako sliko posebej z istim imenom 'attachment'.
  // Ker uporabljamo AJAX FormData, bo to delovalo brez [], in brez prepisovanja.
  for (let i = 0; i < files.length; i++) {
    formData.append("attachment", files[i]);
  }

  // Spremeni gumb
  submitBtn.innerText = "Po≈°iljanje... ‚è≥";
  submitBtn.disabled = true;

  // Po≈°lji na FormSubmit AJAX endpoint
  fetch(`https://formsubmit.co/ajax/${email}`, {
    method: "POST",
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    // Uspeh!
    successMsg.style.display = "block";
    submitBtn.innerText = "Po≈°lji prijavo";
    submitBtn.disabled = false;
    form.reset(); // Poƒçisti obrazec
  })
  .catch(error => {
    // Napaka
    console.error("Error:", error);
    failMsg.style.display = "block";
    failMsg.textContent = "‚ùå Napaka stre≈ænika. Preveri internet ali poskusi z manj slikami.";
    submitBtn.innerText = "Po≈°lji prijavo";
    submitBtn.disabled = false;
  });
});
</script>

</body>
</html>